# Internationalization (i18n)

The internationalization system uses [next-intl](https://next-intl.dev/) v4.3.5 to provide multi-language support across the application.

## Overview

The i18n system provides:

-   Multi-language support with English and German by default
-   Locale detection from cookies and headers
-   Locale-aware routing with URL prefixes
-   Server-side and client-side translation utilities
-   Language selector component
-   Locale cookie management
-   Deep merge of translations with fallback to default locale

## Architecture

```
packages/i18n/
├── lib/
│   └── messages.ts          # Message loading utilities
├── translations/
│   ├── en.json             # English translations
│   └── de.json             # German translations
├── index.ts                # Package exports
├── types.ts                # TypeScript types
└── package.json

apps/web/modules/i18n/
├── lib/
│   ├── locale-cookie.ts    # Cookie management
│   └── update-locale.ts    # Server action for locale updates
├── routing.ts              # Routing configuration
└── request.ts              # Request configuration
```

## Configuration

### Application Configuration

Internationalization is configured in `config/index.ts`:

```typescript
i18n: {
  enabled: true,
  locales: {
    en: {
      currency: 'USD',
      label: 'English',
    },
    de: {
      currency: 'USD',
      label: 'Deutsch',
    },
  },
  defaultLocale: 'en',
  defaultCurrency: 'USD',
  localeCookieName: 'NEXT_LOCALE',
}
```

**Options:**

-   `enabled` - Enable/disable i18n system
-   `locales` - Supported locales with currency and label
-   `defaultLocale` - Fallback locale
-   `defaultCurrency` - Default currency for pricing
-   `localeCookieName` - Cookie name for storing locale preference

### Routing Configuration

The routing configuration is in `apps/web/modules/i18n/routing.ts`:

```typescript
import { config } from "@shipos/config";
import { createNavigation } from "next-intl/navigation";
import { defineRouting } from "next-intl/routing";

export const routing = defineRouting({
	locales: Object.keys(config.i18n.locales),
	defaultLocale: config.i18n.defaultLocale,
	localeCookie: {
		name: config.i18n.localeCookieName,
	},
	localePrefix: config.i18n.enabled ? "always" : "never",
	localeDetection: config.i18n.enabled,
});
```

**Features:**

-   Locale prefix in URLs when i18n is enabled
-   Automatic locale detection from cookies
-   Locale cookie management

### Request Configuration

The request configuration is in `apps/web/modules/i18n/request.ts`:

```typescript
import { getUserLocale } from "@i18n/lib/locale-cookie";
import { routing } from "@i18n/routing";
import { config } from "@shipos/config";
import { getMessagesForLocale } from "@shipos/i18n";
import { getRequestConfig } from "next-intl/server";

export default getRequestConfig(async ({ requestLocale }) => {
	let locale = await requestLocale;

	if (!locale) {
		locale = await getUserLocale();
	}

	if (!(routing.locales.includes(locale) && config.i18n.enabled)) {
		locale = routing.defaultLocale;
	}

	return {
		locale,
		messages: await getMessagesForLocale(locale),
	};
});
```

**Features:**

-   Loads locale from request or cookie
-   Falls back to default locale if invalid
-   Loads and merges translation messages

### Next.js Configuration

The next-intl plugin is configured in `apps/web/next.config.ts`:

```typescript
import nextIntlPlugin from "next-intl/plugin";

const withNextIntl = nextIntlPlugin("./modules/i18n/request.ts");

const nextConfig: NextConfig = {
	// ... other config
};

export default withNextIntl(nextConfig);
```

### Middleware

The middleware handles locale routing in `apps/web/middleware.ts`:

```typescript
import { routing } from "@i18n/routing";
import createMiddleware from "next-intl/middleware";

const intlMiddleware = createMiddleware(routing);

export default async function middleware(req: NextRequest) {
	// ... auth and other middleware logic

	// Apply i18n middleware for marketing pages
	return intlMiddleware(req);
}
```

**Paths without locale prefix:**

-   `/app/*` - SaaS application routes
-   `/auth/*` - Authentication routes
-   `/onboarding` - Onboarding flow
-   `/choose-plan` - Plan selection
-   `/api/*` - API routes

## Translation Files

### Package Translations

Translation files are stored in `packages/i18n/translations/`:

**English (`en.json`):**

```json
{
	"common": {
		"loading": "Loading...",
		"error": "An error occurred",
		"success": "Success"
	},
	"mail": {
		"common": {
			"openLinkInBrowser": "If you want to open the link in a different browser..."
		},
		"emailVerification": {
			"body": "Hey,\\nplease click the link below to verify this new email address.",
			"confirmEmail": "Verify email",
			"subject": "Verify your email"
		}
	}
}
```

**German (`de.json`):**

```json
{
	"common": {
		"loading": "Laden...",
		"error": "Ein Fehler ist aufgetreten",
		"success": "Erfolgreich"
	},
	"mail": {
		"emailVerification": {
			"body": "Hallo,\\nbitte klicken Sie auf den Link unten...",
			"confirmEmail": "E-Mail bestätigen",
			"subject": "Bestätigen Sie Ihre E-Mail"
		}
	}
}
```

### Message Loading

Messages are loaded with fallback support:

```typescript
import { getMessagesForLocale } from "@shipos/i18n";

// Loads locale messages and merges with default locale
const messages = await getMessagesForLocale("de");
```

**Features:**

-   Deep merge with default locale
-   Missing translations fall back to default locale
-   Async loading for code splitting

## Usage

### Server Components

Use `useTranslations` in server components:

```typescript
import { useTranslations } from "next-intl";

export default function Page() {
	const t = useTranslations();

	return (
		<div>
			<h1>{t("common.loading")}</h1>
			<p>{t("mail.emailVerification.body")}</p>
		</div>
	);
}
```

### Client Components

Use `useTranslations` in client components:

```typescript
"use client";

import { useTranslations } from "next-intl";

export function Component() {
	const t = useTranslations();

	return <button>{t("common.success")}</button>;
}
```

### With Parameters

Pass parameters to translations:

```typescript
const t = useTranslations();

// Translation: "Hello, {name}!"
t("greeting", { name: "John" });
// Output: "Hello, John!"
```

### Namespaced Translations

Use namespaces for organization:

```typescript
const t = useTranslations("mail.emailVerification");

t("subject"); // "Verify your email"
t("body"); // "Hey, please click..."
```

### Formatting

Use `useFormatter` for dates, numbers, and currencies:

```typescript
import { useFormatter } from "next-intl";

function Component() {
	const format = useFormatter();

	return (
		<div>
			<p>{format.dateTime(new Date(), { dateStyle: "long" })}</p>
			<p>
				{format.number(1234.56, { style: "currency", currency: "USD" })}
			</p>
		</div>
	);
}
```

## Locale Management

### Get Current Locale

```typescript
import { useLocale } from "next-intl";

function Component() {
	const locale = useLocale();
	return <div>Current locale: {locale}</div>;
}
```

### Server-Side Locale Cookie

```typescript
import { getUserLocale, setLocaleCookie } from "@i18n/lib/locale-cookie";

// Get locale from cookie
const locale = await getUserLocale();

// Set locale cookie
await setLocaleCookie("de");
```

### Update Locale

```typescript
import { updateLocale } from "@i18n/lib/update-locale";

// Server action to update locale
await updateLocale("de");
```

## Navigation

### Locale-Aware Links

Use `LocaleLink` for locale-aware navigation:

```typescript
import { LocaleLink } from "@i18n/routing";

function Navigation() {
	return (
		<nav>
			<LocaleLink href="/about">About</LocaleLink>
			<LocaleLink href="/contact">Contact</LocaleLink>
		</nav>
	);
}
```

### Programmatic Navigation

Use `useLocaleRouter` for programmatic navigation:

```typescript
import { useLocaleRouter } from "@i18n/routing";

function Component() {
	const router = useLocaleRouter();

	const navigate = () => {
		router.push("/dashboard");
	};

	return <button onClick={navigate}>Go to Dashboard</button>;
}
```

### Get Locale Pathname

Use `useLocalePathname` to get the current pathname:

```typescript
import { useLocalePathname } from "@i18n/routing";

function Component() {
	const pathname = useLocalePathname();
	return <div>Current path: {pathname}</div>;
}
```

## Language Selector

The `LocaleSwitch` component provides a language selector:

```typescript
import { LocaleSwitch } from "@shared/components/LocaleSwitch";

function Header() {
	return (
		<header>
			<LocaleSwitch />
		</header>
	);
}
```

**Props:**

-   `withLocaleInUrl` (optional) - Whether to include locale in URL (default: `true`)

**Features:**

-   Dropdown menu with all available locales
-   Updates URL with new locale
-   Updates locale cookie
-   Refreshes page to apply new locale

## Email Translations

Emails are sent in the user's preferred language:

```typescript
import { sendEmail } from "@shipos/mail";

await sendEmail({
	to: user.email,
	locale: user.locale || "en",
	templateId: "emailVerification",
	context: {
		url: verificationUrl,
		name: user.name,
	},
});
```

**Locale Detection:**

The auth system detects locale from cookies:

```typescript
function getLocaleFromRequest(request?: Request): string {
	if (!request) return config.i18n.defaultLocale;

	const cookies = parseCookies(request.headers.get("cookie") ?? "");
	return cookies[config.i18n.localeCookieName] ?? config.i18n.defaultLocale;
}
```

## Adding New Locales

### 1. Add Locale to Configuration

```typescript
// config/index.ts
i18n: {
  locales: {
    en: { currency: 'USD', label: 'English' },
    de: { currency: 'EUR', label: 'Deutsch' },
    fr: { currency: 'EUR', label: 'Français' }, // New locale
  },
}
```

### 2. Create Translation File

Create `packages/i18n/translations/fr.json`:

```json
{
	"common": {
		"loading": "Chargement...",
		"error": "Une erreur s'est produite",
		"success": "Succès"
	}
}
```

### 3. Restart Development Server

```bash
pnpm dev
```

The new locale will be automatically available in the language selector.

## Adding New Translations

### 1. Add to English File

```json
// packages/i18n/translations/en.json
{
	"dashboard": {
		"welcome": "Welcome back, {name}!",
		"stats": {
			"users": "Total Users",
			"revenue": "Revenue"
		}
	}
}
```

### 2. Add to Other Locales

```json
// packages/i18n/translations/de.json
{
	"dashboard": {
		"welcome": "Willkommen zurück, {name}!",
		"stats": {
			"users": "Gesamtbenutzer",
			"revenue": "Umsatz"
		}
	}
}
```

### 3. Use in Components

```typescript
const t = useTranslations("dashboard");

<h1>{t("welcome", { name: user.name })}</h1>;
<p>{t("stats.users")}</p>;
```

## URL Structure

### With i18n Enabled

```
/en/about       # English about page
/de/about       # German about page
/en/blog/post   # English blog post
/de/blog/post   # German blog post
```

### Without i18n Enabled

```
/about          # About page (no locale prefix)
/blog/post      # Blog post (no locale prefix)
```

### Paths Without Locale

These paths never have locale prefixes:

```
/app            # SaaS application
/auth/login     # Authentication
/api/users      # API endpoints
```

## Best Practices

### Organize Translations

Use nested objects for organization:

```json
{
	"auth": {
		"login": {
			"title": "Sign In",
			"email": "Email",
			"password": "Password"
		},
		"signup": {
			"title": "Create Account"
		}
	}
}
```

### Use Namespaces

```typescript
// Good - Use namespaces
const t = useTranslations("auth.login");
t("title"); // "Sign In"

// Avoid - Long keys
const t = useTranslations();
t("auth.login.title");
```

### Provide Context

Use parameters for dynamic content:

```typescript
// Good - With parameters
t("greeting", { name: user.name });

// Avoid - String concatenation
`${t("hello")} ${user.name}`;
```

### Keep Keys Consistent

Use the same key structure across all locales:

```json
// en.json
{
	"button": {
		"save": "Save",
		"cancel": "Cancel"
	}
}

// de.json
{
	"button": {
		"save": "Speichern",
		"cancel": "Abbrechen"
	}
}
```

### Test All Locales

Test your application in all supported locales:

```bash
# Test English
http://localhost:3000/en

# Test German
http://localhost:3000/de
```

## Troubleshooting

### Common Issues

**Issue: "Locale not found"**

-   Solution: Ensure locale is added to `config.i18n.locales`

**Issue: "Translation missing"**

-   Solution: Add translation to all locale files or rely on fallback

**Issue: "Locale not persisting"**

-   Solution: Check that `localeCookieName` is set correctly

**Issue: "URL not updating with locale"**

-   Solution: Use `LocaleLink` or `useLocaleRouter` for navigation

## Performance

### Code Splitting

Translations are loaded asynchronously for code splitting:

```typescript
// Lazy load translations
const messages = await getMessagesForLocale(locale);
```

### Caching

Translation messages are cached after first load.

### Bundle Size

Only the current locale's translations are loaded, reducing bundle size.

## Next Steps

-   [Configuration](./configuration.md) - Configure i18n settings
-   [Email](./email.md) - Send locale-aware emails
-   [Authentication](./authentication.md) - Locale detection in auth flows

## Resources

-   [next-intl Documentation](https://next-intl.dev/)
-   [Next.js Internationalization](https://nextjs.org/docs/app/building-your-application/routing/internationalization)
-   [ICU Message Format](https://formatjs.io/docs/core-concepts/icu-syntax/)
